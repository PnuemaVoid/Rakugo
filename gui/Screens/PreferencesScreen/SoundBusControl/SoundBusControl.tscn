[gd_scene load_steps=3 format=2]

[sub_resource type="GDScript" id=1]
script/source = "extends VBoxContainer

export var default_volume := -30
export(String) var label := \"Volume\"
export(String) var bus_name := \"Master\"
var bus_id := 0
var volume := 0.0
var mute := false


func _ready() -> void:
	bus_id = AudioServer.get_bus_index(bus_name)
	$VBox/Label.text = label
	
	mute = false
	
	if bus_name in settings.audio_buses:
		mute = bool(settings.audio_buses[bus_name].mute)
	
	AudioServer.set_bus_mute(bus_id, mute)
	$VBox/CheckButton.pressed = !mute
	$VBox/CheckButton.connect(\"toggled\", self, \"set_bus_on\" )
	
	volume = default_volume
	
	if bus_name in settings.audio_buses:
		volume = float(settings.audio_buses[bus_name].volume)
	
	AudioServer.set_bus_volume_db(bus_id, volume)
	$Bar.value = volume
	
	$Bar.connect(\"value_changed\", self, \"set_bus_volume\")
	connect(\"visibility_changed\", self, \"_on_visibility_changed\")


func _on_visibility_changed() -> void:
	if not visible:
		return
	
	volume = AudioServer.get_bus_volume_db(bus_id)
	$Bar.value = volume
	mute = AudioServer.is_bus_mute(bus_id)
	$VBox/CheckButton.pressed = !mute
	settings.audio_buses[bus_name] = {\"mute\":mute, \"volume\":volume}
#	prints(\"bus:\", bus_name, bus_id,
#	AudioServer.get_bus_name(bus_id),
#	AudioServer.get_bus_index(bus_name),
#	\"volume:\", volume, \"mute:\", mute)


func set_bus_volume(value: int):
	AudioServer.set_bus_volume_db(bus_id, value)
	volume = value
	settings.audio_buses[bus_name] = {\"mute\":mute, \"volume\":volume}
#	prints(\"bus:\", bus_name, bus_id,
#	AudioServer.get_bus_name(bus_id),
#	AudioServer.get_bus_index(bus_name),
#	\"volume:\", volume)


func set_bus_on(value: bool) -> void:
	AudioServer.set_bus_mute(bus_id, !value)
	mute = value
#	prints(\"bus:\", bus_name, bus_id,
#	AudioServer.get_bus_name(bus_id),
#	AudioServer.get_bus_index(bus_name),
#	\"mute:\", mute)
"

[sub_resource type="StreamTexture" id=2]
flags = 4
load_path = "res://.import/sound-on.png-c7069ca607a583f763fc164615f5a3ee.stex"

[node name="SoundBusControl" type="VBoxContainer"]
margin_top = 34.0
margin_right = 400.0
margin_bottom = 124.0
script = SubResource( 1 )
__meta__ = {
"_edit_use_anchors_": false
}
default_volume = -20

[node name="VBox" type="HBoxContainer" parent="."]
margin_right = 400.0
margin_bottom = 52.0
size_flags_horizontal = 3
size_flags_vertical = 3

[node name="Label" type="Label" parent="VBox"]
margin_right = 246.0
margin_bottom = 52.0
size_flags_horizontal = 3
size_flags_vertical = 3
text = "Volume"
align = 1
valign = 1

[node name="CheckButton" type="CheckButton" parent="VBox"]
margin_left = 250.0
margin_right = 400.0
margin_bottom = 52.0
rect_min_size = Vector2( 150, 0 )
pressed = true
icon = SubResource( 2 )

[node name="Bar" type="HSlider" parent="."]
margin_top = 56.0
margin_right = 400.0
margin_bottom = 90.0
size_flags_horizontal = 3
size_flags_vertical = 3
min_value = -50.0
max_value = 12.0
step = 0.1
rounded = true
